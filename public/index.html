<html>
    <head>
        <title>Interanual - Javiscript.me</title>
        <link rel="stylesheet" href="css/style.css" />
    </head>

    <body>
        <h1>Interanual</h1>

        <div id="chart-wrapper"></div>

        <div id="info-box"></div>

        <ul id="metric-selector">
            <li class="toggle" data-key="total">total</li>
            <li class="toggle" data-key="hombres">hombres</li>
            <li class="toggle" data-key="mujeres">mujeres</li>
            <li class="toggle" data-key="hombresMenor25">hombresMenor25</li>
            <li class="toggle" data-key="mujeresMenor25">mujeresMenor25</li>
            <li class="toggle" data-key="totalMenor25">totalMenor25</li>
            <li class="toggle" data-key="hombresMayor25">hombresMayor25</li>
            <li class="toggle" data-key="mujeresMayor25">mujeresMayor25</li>
            <li class="toggle" data-key="totalMayor25">totalMayor25</li>
            <li class="toggle" data-key="agricultura">agricultura</li>
            <li class="toggle" data-key="industria">industria</li>
            <li class="toggle" data-key="construccion">construccion</li>
            <li class="toggle" data-key="servicios">servicios</li>
            <li class="toggle" data-key="sinEmpleo">sinEmpleo</li>
            <li class="title">Regions</li>
            <li class="toggle" data-key="andalucia">andalucia</li>
            <li class="toggle" data-key="aragon">aragon</li>
            <li class="toggle" data-key="asturias">asturias</li>
            <li class="toggle" data-key="balears">balears</li>
            <li class="toggle" data-key="canarias">canarias</li>
            <li class="toggle" data-key="cantabria">cantabria</li>
            <li class="toggle" data-key="castillaMancha">castillaMancha</li>
            <li class="toggle" data-key="castillaLeon">castillaLeon</li>
            <li class="toggle" data-key="catalunya">catalunya</li>
            <li class="toggle" data-key="comValenciana">comValenciana</li>
            <li class="toggle" data-key="extremadura">extremadura</li>
            <li class="toggle" data-key="galicia">galicia</li>
            <li class="toggle" data-key="madrid">madrid</li>
            <li class="toggle" data-key="murcia">murcia</li>
            <li class="toggle" data-key="navarra">navarra</li>
            <li class="toggle" data-key="paisVasco">paisVasco</li>
            <li class="toggle" data-key="rioja">rioja</li>
            <li class="toggle" data-key="ceuta">ceuta</li>
            <li class="toggle" data-key="melilla">melilla</li>
        </ul>
    </body>

    <script type="text/template" id="info-box-tpl">
        <div class="current">
            <h3><%= currentDate %></h3>
            <div class="value"><%= currentTotal %></div>
        </div>
        <div class="previous">
            <h3><%= prevYearDate %></h3>
            <% if ( prevYear ) { %>
                <div class="value"><%= prevYearTotal %></div>
                <div class="value"><%= interannualValue %></div>
            <% } else { %>
                Sin Datos
            <% } %>
        </div>
        <div class="interannualDiff">
            <h3>IA Diff</h3>
            <% if ( interannualDiff ) { %>
                <div class="value"><%= interannualDiffValue %></div>
            <% } else { %>
                Sin Datos
            <% } %>
        </div>
    </script>

    <script type="text/javascript" src="vendor/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="vendor/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="vendor/moment/min/moment.min.js"></script>
    <script type="text/javascript" src="vendor/d3/d3.min.js"></script>
    <script type="text/javascript">

        _.mixin({
            numberFormat: function (number, decimals, dec_point, thousands_sep) {
                // http://phpjs.org/functions/number_format

                number = (number + '')
                        .replace(/[^0-9+\-Ee.]/g, '');
                var n = !isFinite(+number) ? 0 : +number,
                        prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
                        sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
                        dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
                        s = '',
                        toFixedFix = function (n, prec) {
                            var k = Math.pow(10, prec);
                            return '' + (Math.round(n * k) / k)
                                            .toFixed(prec);
                        };
                // Fix for IE parseFloat(0.55).toFixed(0) = 0;
                s = (prec ? toFixedFix(n, prec) : '' + Math.round(n))
                        .split('.');
                if (s[0].length > 3) {
                    s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
                }
                if ((s[1] || '')
                                .length < prec) {
                    s[1] = s[1] || '';
                    s[1] += new Array(prec - s[1].length + 1)
                            .join('0');
                }
                return s.join(dec);
            },
            numberSign: function (number) {
                return (number > 0) ? '+' : '';
            }
        });

        var ianual = {

            $infoBox: null,

            init: function () {

                this.$infoBox = $('#info-box');

                this.tpls = {
                    infoBox: _.template( $('#info-box-tpl').html() )
                };

                this.chart = new IaChart({
                    cb: this.updateInfoBox
                });

                $('#metric-selector').find('li.toggle').on('click', function () {
                    ianual.chart.update({
                        keys: [ $(this).data('key') ]
                    });
                });
            },

            prevYearId: function ( id ) {
                var ym = id.split('-'),
                    y1y = parseInt(ym[0], 10) - 1;

                return ( ( y1y >= 10 ) ? y1y : ('0' + y1y) ) + '-' + ym[1];
            },

            updateInfoBox: function (data) {

                var infoBoxData = {
                        currentDate: moment(data.x).format('YYYY-MMM'),
                        currentTotal: _.numberFormat(data.y),
                        prevYearDate: moment(data.x).subtract(1, 'year').format('YYYY-MMM'),
                        prevYear: false,
                        interannualDiff: false
                    },
                    interannualDiff;


                if ( data.y1y ) {
                    infoBoxData.prevYear = true;
                    infoBoxData.prevYearTotal = _.numberFormat(data.y1y);
                    interannualDiff = data.y - data.y1y;
                    infoBoxData.interannualValue = _.numberSign(interannualDiff) + _.numberFormat(interannualDiff);
                }

                if ( data.y1y1m ) {
                    infoBoxData.interannualDiff = true;
                    infoBoxData.interannualDiffValue = _.numberFormat(data.y1y - data.y1y1m);
                }

                ianual.$infoBox.html(ianual.tpls.infoBox(infoBoxData));
            }
        };

        var IaChart = function ( options ) {
            this.margin = {top: 20, right: 20, bottom: 30, left: 20};
            this.oWidth = $('#chart-wrapper').outerWidth(true);
            this.oHeight = 400;
            this.width = null;
            this.height = null;

            this.csvData = null;

            this.defaults = {
                keys: ['total']
            };
            this.options = options;

            this.x = null;
            this.y = null;
            this.line = null;
            this.color = null;

            this.keys = null;
            this.keysLen = null;
            this.series = null;
            this.series1y = null;
            this.numPoints = null;
            this.pointWidth = null;

            this.svg = null;
            this.guideLine = null;
            this.diffLines = null;
            this.serie = null;
            this.serie1y = null;
            this.diffDot = null;
            this.hoverable = null;

            this.init(options);
        }

        IaChart.prototype = {

            init: function () {
                var _this = this;

                this.options = $.extend(true, this.defaults, this.options);

                d3.csv('data/interanual.csv', function (csvData) {
                    _this.csvData = csvData.reverse();
                    _this.build();
                });
            },

            build: function () {
                var _this = this;
                this.width = this.oWidth - this.margin.left - this.margin.right;
                this.height = this.oHeight - this.margin.top - this.margin.bottom;

                this.x = d3.time.scale()
                        .range([0, this.width]);

                this.y = d3.scale.linear()
                        .range([this.height, 0]);

                this.line = d3.svg.line()
                        .interpolate('monotone')
                        .defined(function (d) {
                            return d.y !== null;
                        })
                        .x(function (d) {
                            return _this.x(d.x);
                        })
                        .y(function (d) {
                            return _this.y(d.y);
                        });

                this.svg = d3.select('#chart-wrapper').append('svg')
                        .attr('width', this.oWidth)
                        .attr('height', this.oHeight)
                        .attr('class', 'ianual-chart')
                        .append('g')
                        .attr('transform', this.translateStr(this.margin.left, this.margin.top));

                this.color = d3.scale.category10();

                this.calculate();

                this.buildSvg();
            },

            calculate: function ()  {
                var _this = this;

                this.keys = this.options.keys;
                this.keysLen = this.keys.length;

                var dataByPeriod = {},
                        dataLen = this.csvData.length,
                        prevYear;
                this.series1y = null;

                this.color.domain(this.keys);

                this.series = this.keys.map(function (d) {
                    return {
                        name: d,
                        values: []
                    }
                });

                for (var i = 0; i < dataLen; i++) {
                    dataByPeriod[this.csvData[i].periodo] = this.csvData[i];
                }

                this.csvData.forEach(function (d) {
                    _this.keys.forEach(function (keyName, i) {
                        prevYear = ianual.prevYearId(d.periodo);
                        _this.series[i].values.push({
                            x: +d.ts,
                            y: +d[keyName],
                            y1y: dataByPeriod[prevYear] ? +dataByPeriod[prevYear][keyName] : null
                        });
                    });
                });

                if (this.keysLen == 1) {
                    this.series1y = {
                        name: this.keys[0] + '-1y',
                        values: []
                    };

                    this.csvData.forEach(function (d) {
                        prevYear = ianual.prevYearId(d.periodo);
                        _this.series1y.values.push({
                            x: +d.ts,
                            y: dataByPeriod[prevYear] ? +dataByPeriod[prevYear][_this.keys[0]] : null
                        });
                    });
                }

                this.numPoints = this.series[0].values.length;
                this.pointWidth = this.width / (this.numPoints - 1);

                this.x.domain(d3.extent(this.series[0].values, function (d) {
                    return d.x;
                }));
                this.y.domain([0, d3.max(this.series, function (d) {
                    return d3.max(d.values, function (dd) {
                        return dd.y
                    });
                })]);
            },

            buildSvg: function () {
                var _this = this;

                this.axisLines = this.svg.append('g')
                        .attr('class', 'axis-lines');

                this.axisLines.selectAll('.axis-lines')
                        .data([ 1e6, 2e6, 3e6, 4e6, 5e6 ])
                        .enter().append('line')
                        .attr('x1', 0)
                        .attr('y1', function (d) { return _this.y(d); })
                        .attr('x2', _this.x.range()[1])
                        .attr('y2', function (d) { return _this.y(d); })
                        .attr('stroke', '#f8f8f8')
                        .attr('stroke-width', '1px');
                this.axisLines.append('line')
                        .attr('x1', 0)
                        .attr('y1', _this.y.range()[0])
                        .attr('x2', _this.x.range()[1])
                        .attr('y2', _this.y.range()[0])
                        .attr('stroke', '#e8e8e8')
                        .attr('stroke-width', '3px');
                this.axisLines.selectAll('.axis-text')
                        .data([ 1e6, 2e6, 3e6, 4e6, 5e6 ])
                        .enter().append('text')
                        .attr('x', 0)
                        .attr('y', function (d) { return _this.y(d) - 10; })
                        .text(function (d) { return (d / 1e6) + 'M'; });

                this.axisLines.selectAll('.axis-text')
                        .data([ 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015 ])
                        .enter().append('text')
                        .attr('x', function (d) { return _this.x(moment([d, 6, 1]).unix() * 1000); })
                        .attr('y', _this.y.range()[0] + 16)
                        .attr('text-anchor', 'middle')
                        .text(function (d) { return d });

                this.guideLine = this.svg.append('g')
                    .attr('class', 'guide-line')
                    .attr('opacity', 0);

                this.guideLine.append('line')
                    .attr('x1', 0)
                    .attr('y1', this.y.range()[0])
                    .attr('x2', 0)
                    .attr('y2', this.y.range()[1])
                    .attr('stroke', '#d0d0d0')
                    .attr('stroke-width', '1px')
                    .attr('stroke-dasharray', '2,2');

                if ( this.series1y !== null ) {
                    this.serie1y = this.svg.append('g')
                        .attr('class', 'serie-1y');

                    this.serie1y.selectAll('.path')
                        .data([ this.series1y ])
                        .enter().append('path')
                        .attr('class', 'line-1y')
                        .attr('d', function (d) { return _this.line(d.values); })
                        .attr('stroke', '#e0e0e0')
                        .attr('stroke-width', '2px')
                        .attr('fill', 'none');

                    this.diffLines = this.svg.append('g')
                        .attr('class', 'diff-lines');

                    this.diffLines.selectAll('.diff-line')
                        .data(this.series[0].values)
                        .enter().append('line')
                        .attr('class', 'diff-line')
                        .attr('x1', function (d) { return _this.x(d.x); })
                        .attr('y1', function (d) { return _this.y(d.y); })
                        .attr('x2', function (d) { return _this.x(d.x); })
                        .attr('y2', function (d) { return _this.y(d.y1y); })
                        .attr('stroke', function (d) { return ( d.y > d.y1y ) ? '#f48fb1' : '#a5d6a7'; })
                        .attr('stroke-width', '2px')
                        .attr('opacity', function (d) { return ( d.y1y === null ) ? 0 : .2; })
                        .attr('fill', 'none');
                }

                this.serie = this.svg.selectAll('.serie')
                    .data(this.series)
                    .enter().append('g')
                    .attr('class', 'serie');

                this.serie.append('path')
                    .attr('class', 'line')
                    .attr('d', function (d) { return _this.line(d.values); })
                    .attr('stroke', this.keysLen === 1 ? '#808080' : function (d) { return _this.color(d.name); })
                    .attr('stroke-width', '3px')
                    .attr('fill', 'none');

                this.serie.append('circle')
                    .attr('class', 'serie-dot')
                    .attr('cx', 0)
                    .attr('cy', 0)
                    .attr('r', '4px')
                    .attr('opacity', 0)
                    .attr('fill', '#ffffff')
                    .attr('stroke', this.keysLen === 1 ? '#808080' : function (d) { return _this.color(d.name); })
                    .attr('stroke-width', '3px');

                if (this.series1y !== null) {

                    this.diffDot = this.svg.append('g')
                        .attr('class', 'diff-dot');

                    this.diffDot.append('circle')
                        .attr('cx', 0)
                        .attr('cy', 0)
                        .attr('r', '4px')
                        .attr('opacity', 0)
                        .attr('fill', '#ffffff')
                        .attr('stroke', '#808080')
                        .attr('stroke-width', '3px');
                }

                this.hoverable = this.svg.append('rect')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', this.width)
                    .attr('height', this.height + 20)
                    .attr('fill', '#ffffff')
                    .attr('opacity', 0)
                    .attr('transform', this.translateStr(0, -10))
                    .on('mousemove', function () { _this.chartMouseMove.call( _this, d3.mouse(this) ); })
                    .on('mouseout', function () { _this.chartMouseOut.call( _this ); });
            },

            chartMouseMove: function (m) {
                var _this = this,
                    mIdx = Math.floor((m[0] + this.pointWidth / 2) / this.pointWidth);

                var point = this.series[0].values[mIdx],
                    pointColor = point.y1y === null ? '#808080' : ( point.y > point.y1y ) ? '#f48fb1' : '#a5d6a7',
                    pointY = point.y1y === null ? this.y(point.y) : this.y(point.y1y);

                point.y1y1m = this.series[0].values[mIdx-1] && this.series[0].values[mIdx-1].y1y
                    ? this.series[0].values[mIdx-1].y1y
                    : null;

                this.options.cb(point);

                this.serie.selectAll('circle')
                    .attr('opacity', 1)
                    .attr('transform', function (d) { return _this.translateStr(_this.x(point.x), _this.y(d.values[mIdx].y)); });

                this.guideLine
                    .attr('opacity', 1)
                    .attr('transform', this.translateStr(this.x(point.x), 0));

                if (this.diffDot !== null) {
                    this.diffDot.select('circle')
                            .attr('stroke', pointColor)
                            .attr('opacity', 1)
                            .attr('transform', this.translateStr(this.x(point.x), pointY));
                }

                if (this.diffLines && point.y1y !== null) {
                    var allLines = this.diffLines.selectAll('line').classed('active', false);
                    d3.select(allLines[0][mIdx]).classed('active', true);
                }
            },

            chartMouseOut: function () {
                this.serie.selectAll('circle').attr('opacity', 0);
                this.guideLine.attr('opacity', 0);
                if (this.diffDot !== null) {
                    this.diffDot.select('circle').attr('opacity', 0);
                }
                if (this.diffLines !== null) {
                    this.diffLines.selectAll('line').classed('active', false);
                }
            },

            emptyChart: function () {
                // Remove all children of this.container
                var children = this.svg.node().childNodes;
                var count = children.length;
                for (var i = count - 1 ; i >= 0 ; i--) {
                    // removing children[i] crashes in iPad, selecting the node with d3 and removing it works!!
                    d3.select(children[i]).remove();
                }
            },

            update: function (options) {
                this.options = $.extend(this.options, options);
                this.emptyChart();
                this.calculate();
                this.buildSvg();
            },

            translateStr: function (x, y) {
                return 'translate(' + [x, y].join(',') + ')';
            },

        };

        ianual.init();

    </script>
</html>